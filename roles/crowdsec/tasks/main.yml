---
- name: Add CrowdSec apt repository
  ansible.builtin.shell: curl -s https://install.crowdsec.net | bash
  args:
    creates: /etc/apt/sources.list.d/crowdsec_crowdsec.list

- name: Install CrowdSec
  apt:
    name: crowdsec
    state: latest
    update_cache: yes

- name: Enable and start CrowdSec
  systemd:
    name: crowdsec
    enabled: yes
    state: started

- name: Bind CrowdSec LAPI to all interfaces (reachable from Docker containers)
  ansible.builtin.lineinfile:
    path: /etc/crowdsec/config.yaml
    regexp: '^\s*listen_addr:\s'
    line: '  listen_addr: 0.0.0.0:8080'
  notify: Restart CrowdSec

- name: Ensure CrowdSec acquisition directory exists
  file:
    path: /etc/crowdsec/acquis.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy Traefik acquisition config
  copy:
    dest: /etc/crowdsec/acquis.d/traefik.yaml
    owner: root
    group: root
    mode: "0644"
    content: |
      filenames:
        - /etc/dokploy/traefik/dynamic/access.log
      labels:
        type: traefik
  notify: Restart CrowdSec

- name: Update CrowdSec hub
  ansible.builtin.shell: cscli hub update

- name: Install CrowdSec Traefik collection
  ansible.builtin.shell: cscli collections install crowdsecurity/traefik
  args:
    creates: /etc/crowdsec/collections/traefik.yaml

- name: Check if bouncer API key already generated
  ansible.builtin.stat:
    path: /etc/crowdsec/.traefik-bouncer-key
  register: bouncer_key_marker

- name: Generate bouncer API key
  ansible.builtin.shell: |
    cscli bouncers add traefik-bouncer -o raw > /etc/crowdsec/.traefik-bouncer-key
    chmod 600 /etc/crowdsec/.traefik-bouncer-key
  args:
    executable: /bin/bash
  when: not bouncer_key_marker.stat.exists

- name: Read bouncer API key
  ansible.builtin.slurp:
    src: /etc/crowdsec/.traefik-bouncer-key
  register: bouncer_key_file

- name: Set bouncer API key fact
  ansible.builtin.set_fact:
    crowdsec_bouncer_api_key: "{{ bouncer_key_file.content | b64decode | trim }}"

- name: Detect docker_gwbridge gateway IP
  ansible.builtin.shell: docker network inspect docker_gwbridge --format '{{ '{{' }}(index .IPAM.Config 0).Gateway{{ '}}' }}'
  register: gwbridge_result
  changed_when: false

- name: Set docker_gwbridge IP fact
  ansible.builtin.set_fact:
    docker_gwbridge_ip: "{{ gwbridge_result.stdout | trim }}"

- name: Deploy CrowdSec bouncer middleware dynamic config
  copy:
    dest: /etc/dokploy/traefik/dynamic/crowdsec-bouncer.yml
    owner: root
    group: root
    mode: "0644"
    content: |
      http:
        middlewares:
          crowdsec-bouncer:
            plugin:
              crowdsec-bouncer-traefik-plugin:
                crowdsecLapiKey: "{{ crowdsec_bouncer_api_key }}"
                crowdsecLapiHost: "{{ docker_gwbridge_ip }}:8080"
                crowdsecMode: live

- name: Add CrowdSec bouncer plugin to Traefik static config
  ansible.builtin.blockinfile:
    path: /etc/dokploy/traefik/traefik.yml
    marker: "# {mark} ANSIBLE MANAGED BLOCK - crowdsec plugin"
    block: |
      experimental:
        plugins:
          crowdsec-bouncer-traefik-plugin:
            moduleName: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
            version: v1.4.1
  notify: Restart Traefik

- name: Add Traefik access log config
  ansible.builtin.blockinfile:
    path: /etc/dokploy/traefik/traefik.yml
    marker: "# {mark} ANSIBLE MANAGED BLOCK - access log"
    block: |
      accessLog:
        filePath: /etc/dokploy/traefik/dynamic/access.log
        format: json
        bufferingSize: 10
  notify: Restart Traefik

- name: Add Cloudflare trusted IPs to Traefik entryPoints
  ansible.builtin.shell: |
    python3 << 'PYEOF'
    import sys, re

    path = '/etc/dokploy/traefik/traefik.yml'
    with open(path) as f:
        content = f.read()

    if 'forwardedHeaders' in content:
        print('OK')
        sys.exit(0)

    cf_ips = [
        '173.245.48.0/20', '103.21.244.0/22', '103.22.200.0/22',
        '103.31.4.0/22', '141.101.64.0/18', '108.162.192.0/18',
        '190.93.240.0/20', '188.114.96.0/20', '197.234.240.0/22',
        '198.41.128.0/17', '162.158.0.0/15', '104.16.0.0/13',
        '104.24.0.0/14', '172.64.0.0/13', '131.0.72.0/22',
        '2400:cb00::/32', '2606:4700::/32', '2803:f800::/32',
        '2405:b500::/32', '2405:8100::/32', '2a06:98c0::/29',
        '2c0f:f248::/32',
    ]

    lines = content.split('\n')
    new_lines = []
    for line in lines:
        new_lines.append(line)
        m = re.match(r'^(\s+)address:\s*"?:(80|443)"?', line)
        if m:
            indent = m.group(1)
            new_lines.append(f'{indent}forwardedHeaders:')
            new_lines.append(f'{indent}  trustedIPs:')
            for ip in cf_ips:
                new_lines.append(f'{indent}    - {ip}')

    with open(path, 'w') as f:
        f.write('\n'.join(new_lines))
    print('CHANGED')
    PYEOF
  args:
    executable: /bin/bash
  register: cf_ips_result
  changed_when: "'CHANGED' in cf_ips_result.stdout"
  when: cloudflare_proxy
  notify: Restart Traefik

- name: Set default middlewares on websecure entryPoint
  ansible.builtin.shell: |
    python3 << 'PYEOF'
    import sys, re

    path = '/etc/dokploy/traefik/traefik.yml'
    with open(path) as f:
        content = f.read()

    if 'security-headers@file' in content:
        print('OK')
        sys.exit(0)

    lines = content.split('\n')
    new_lines = []
    for line in lines:
        new_lines.append(line)
        m = re.match(r'^(\s+)http:\s*$', line)
        if m:
            indent = m.group(1)
            new_lines.append(f'{indent}  middlewares:')
            new_lines.append(f'{indent}    - security-headers@file')
            new_lines.append(f'{indent}    - crowdsec-bouncer@file')

    with open(path, 'w') as f:
        f.write('\n'.join(new_lines))
    print('CHANGED')
    PYEOF
  args:
    executable: /bin/bash
  register: default_mw_result
  changed_when: "'CHANGED' in default_mw_result.stdout"
  notify: Restart Traefik

- name: Flush handlers to restart CrowdSec before continuing
  meta: flush_handlers
